# 热备模式架构图

本目录包含**纯热备模式**（不含快照）的 PlantUML 架构图。

## 图表列表

| 文件 | 描述 |
|------|------|
| `architecture.puml` | 展示 Primary、Standby 及其组件的整体架构 |
| `failover-sequence.puml` | 带时间的详细故障切换流程 |

## 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                         热备架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────┐        ┌───────────────────┐            │
│  │   Primary Master  │ OpLog  │  Standby Master   │            │
│  │                   │ ─────► │                   │            │
│  │  ┌─────────────┐  │        │  ┌─────────────┐  │            │
│  │  │  元数据     │  │  核查  │  │  元数据     │  │            │
│  │  │  存储      │ ◄┼────────┼─ │  存储       │  │            │
│  │  └─────────────┘  │        │  │  (副本)     │  │            │
│  │                   │        │  └─────────────┘  │            │
│  └─────────┬─────────┘        └─────────┬─────────┘            │
│            │                            │                       │
│            │ 租约                       │ 监听                  │
│            ▼                            ▼                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                         etcd                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 核心设计要点

### 1. 基于 OpLog 的复制
- 每个写操作生成一个 OpLog 条目
- OpLog 实时流式传输到所有 Standby
- Standby 应用 OpLog 维护副本元数据

### 2. 核查机制
- Standby 定期采样数据并计算校验和
- 向 Primary 发送 `prefix_hash` + `checksum` 进行验证
- 自动修复少量不一致
- 大量差异时触发全量同步

### 3. 故障切换流程
- etcd 租约过期触发 leader 选举
- 安全窗口防止脑裂
- 热数据支持即时提升

## 渲染方式

```bash
# 生成 PNG
plantuml *.puml

# 生成 SVG
plantuml -tsvg *.puml
```

或使用 VS Code PlantUML 插件: `Alt + D` 预览。

## 关键指标

| 指标 | 目标 |
|------|------|
| **RPO** | < 1 秒 |
| **RTO** | < 10 秒 |
| **复制延迟** | < 100 条目 |
| **核查间隔** | 30 秒 |








